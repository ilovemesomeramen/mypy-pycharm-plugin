# Multi-Module Mypy Support

> **Note:** This document and the associated code changes were generated by an LLM (Claude, Anthropic) in collaboration with a human developer.

## What This Fork Does

This fork adds **per-module mypy configuration** to the [mypy-pycharm-plugin](https://github.com/szabope/mypy-pycharm-plugin). The upstream plugin only supports a single mypy configuration per project. When multiple Python projects are attached in one PyCharm window (File > Open > Attach), they all share one mypy executable, config file, and working directory â€” making the plugin unusable in multi-project setups.

This fork resolves that by detecting the correct mypy configuration for each module automatically.

## How It Works

### Phase 1: Auto-Detection (zero config)

When a file is scanned, the plugin:

1. Finds which **module** the file belongs to via `ModuleUtilCore.findModuleForFile()`
2. Looks up that module's **Python SDK** (`module.pythonSdk`)
3. Finds the **mypy binary** in the SDK's `bin/` directory (e.g. `/path/to/venv/bin/mypy`)
4. Uses the module's **content root** as the working directory, so mypy discovers its own config file (`mypy.ini`, `pyproject.toml`, etc.) automatically

This only activates in multi-module projects. Single-module projects are completely unaffected.

### Phase 2: Explicit Per-Module Settings

For cases where auto-detection isn't enough, a **Module Settings** page is available under **Settings > Tools > Mypy > Module Settings**. Each module can be individually configured with:

- Custom mypy executable path
- Custom config file path
- Custom arguments
- Custom working directory
- Exclude non-project files toggle

### Key Design Decision: `useProjectSdk = false`

The plugin depends on a closed-source base library (`works.szabope.plugins:common`) whose `ToolExecutor` internally uses `project.pythonSdk` when `useProjectSdk = true`. Since we can't modify the base library, all module-specific configurations set `useProjectSdk = false` and pass the explicit mypy executable path resolved from the module's SDK. The base executor then runs that binary directly.

## Changed Files

### New Files

| File | Purpose |
|------|---------|
| `services/MypyConfigurationResolver.kt` | Resolves per-module mypy config (auto-detect + explicit settings) |
| `services/MypyModuleSettings.kt` | Persists per-module setting overrides in `MypyPlugin.xml` |
| `configurable/MypyModuleConfigurable.kt` | Settings UI for per-module configuration |

### Modified Files

| File | Change |
|------|--------|
| `annotator/MypyAnnotator.kt` | `scan()` resolves per-module config via resolver |
| `action/ScanAction.kt` | Groups targets by config, runs separate scans per module |
| `META-INF/plugin.xml` | Changed plugin ID/name to avoid marketplace update conflicts |
| `META-INF/works.szabope.mypy-PythonCore.xml` | Registered module configurable |
| `messages/MypyBundle.properties` | Added module settings UI labels |
| `gradle.properties` | Version bump |

## Building

Requires a GitHub PAT with `read:packages` scope for the base library dependency:

```bash
export GPR_USERNAME=your-github-username
export GPR_TOKEN=ghp_your_token
export JAVA_HOME=/path/to/jdk21
./gradlew buildPlugin
```

The built plugin zip is at `build/distributions/`.

## Debugging

Debug logging is available by adding this to **Help > Diagnostic Tools > Debug Log Settings**:

```
#works.szabope.plugins.mypy.services.MypyConfigurationResolver
```
